# Caddy reverse proxy configuration for Dart Scoring PWA
# This configuration serves the app from a single domain with /api/* routed to backend

# Replace with your actual domain
yourdomain.com {
    # Automatic HTTPS with Let's Encrypt
    # Caddy handles certificate provisioning and renewal automatically

    # Route /api/* to backend canister (MUST come before general handle)
    handle /api/* {
        # Replace with your backend canister ID
        reverse_proxy https://YOUR_BACKEND_CANISTER_ID.ic0.app {
            # Forward original host header
            header_up Host {upstream_hostport}
            
            # Forward client IP
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # Trust IC boundary node certificates
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Route everything else to frontend canister
    handle {
        # Replace with your frontend canister ID
        reverse_proxy https://YOUR_FRONTEND_CANISTER_ID.ic0.app {
            # Forward original host header
            header_up Host {upstream_hostport}
            
            # Forward client IP
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # Trust IC boundary node certificates
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Cache static assets for PWA
    header /assets/* {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # Cache manifest and service worker with shorter TTL
    header /manifest.webmanifest {
        Cache-Control "public, max-age=3600"
    }
    header /service-worker.js {
        Cache-Control "public, max-age=3600"
    }

    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}

# Setup Instructions:
# 1. Replace 'yourdomain.com' with your actual domain
# 2. Replace 'YOUR_BACKEND_CANISTER_ID' with your backend canister ID
# 3. Replace 'YOUR_FRONTEND_CANISTER_ID' with your frontend canister ID
# 4. Install Caddy: https://caddyserver.com/docs/install
# 5. Run: caddy run --config Caddyfile
#
# Important: The 'handle /api/*' block MUST come before the general 'handle' block
# to ensure /api/* requests are routed to the backend and not subject to SPA fallback.
#
# Verification:
# - curl https://yourdomain.com/api/health should return "IC System is healthy."
# - curl -i https://yourdomain.com/api/auth/google/start should return HTTP 302/303
# - curl https://yourdomain.com/ should return the SPA HTML
